<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Asciidoctor 2.0.10" name="generator"/>
  <meta content="Mandar Chitre" name="author"/>
  <title>
   Underwater Networks Handbook
  </title>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700" rel="stylesheet"/>
  <style>
   /* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
  </style>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
 </head>
 <body class="book toc2 toc-left">
  <div id="header">
   <h1>
    Underwater Networks Handbook
   </h1>
   <div class="details">
    <span class="author" id="author">
     Mandar Chitre
    </span>
    <br/>
    <span id="revnumber">
     version 3.1.0
    </span>
   </div>
   <div class="toc2" id="toc">
    <div id="toctitle">
     Table of Contents
    </div>
    <ul class="sectlevel1">
     <li>
      <a href="unet-handbook_preface.html">
       Preface
      </a>
     </li>
     <li>
      <a href="unet-handbook_part_i_introduction_to_unetstack.html">
       <strong>
        Part I: Introduction to UnetStack
       </strong>
      </a>
      <ul class="sectlevel1">
       <li>
        <a href="unet-handbook_introduction.html">
         1. Introduction
        </a>
       </li>
       <li>
        <a href="unet-handbook_getting_started.html">
         2. Getting started
        </a>
       </li>
       <li>
        <a href="unet-handbook_unetstack_basics.html">
         3. UnetStack basics
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="unet-handbook_part_ii_setting_up_underwater_networks.html">
       <strong>
        Part II: Setting up underwater networks
       </strong>
      </a>
      <ul class="sectlevel1">
       <li>
        <a href="unet-handbook_unet_basics.html">
         4. Unet basics
        </a>
       </li>
       <li>
        <a href="unet-handbook_setting_up_small_networks.html">
         5. Setting up small networks
        </a>
       </li>
       <li>
        <a href="unet-handbook_routing_in_larger_networks.html">
         6. Routing in larger networks
        </a>
       </li>
       <li>
        <a href="unet-handbook_wired_and_over_the_air_links.html">
         7. Wired and over-the-air links
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="unet-handbook_part_iii_building_unet_applications.html">
       <strong>
        Part III: Building Unet applications
       </strong>
      </a>
      <ul class="sectlevel1">
       <li>
        <a href="unet-handbook_interfacing_with_unetstack.html">
         8. Interfacing with UnetStack
        </a>
       </li>
       <li>
        <a href="unet-handbook_unetsocket_api.html">
         9. UnetSocket API
        </a>
       </li>
       <li>
        <a href="unet-handbook_portals.html">
         10. Portals
        </a>
       </li>
       <li>
        <a href="unet-handbook_wormholes.html">
         11. Wormholes
        </a>
       </li>
       <li>
        <a href="unet-handbook_at_script_engine.html">
         12. AT script engine
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="unet-handbook_part_iv_understanding_unetstack_services.html">
       <strong>
        Part IV: Understanding UnetStack services
       </strong>
      </a>
      <ul class="sectlevel1">
       <li>
        <a href="unet-handbook_services_and_capabilities.html">
         13. Services and capabilities
        </a>
       </li>
       <li>
        <a href="unet-handbook_datagram_service.html">
         14. Datagram service
        </a>
       </li>
       <li>
        <a href="unet-handbook_physical_service.html">
         15. Physical service
        </a>
       </li>
       <li>
        <a href="unet-handbook_baseband_service.html">
         16. Baseband service
        </a>
       </li>
       <li>
        <a href="unet-handbook_ranging_and_synchronization.html">
         17. Ranging and synchronization
        </a>
       </li>
       <li>
        <a href="unet-handbook_node_information.html">
         18. Node information
        </a>
       </li>
       <li>
        <a href="unet-handbook_address_resolution.html">
         19. Address resolution
        </a>
       </li>
       <li>
        <a href="unet-handbook_medium_access_control.html">
         20. Medium access control
        </a>
       </li>
       <li>
        <a href="unet-handbook_single_hop_links.html">
         21. Single-hop links
        </a>
       </li>
       <li>
        <a href="unet-handbook_routing_and_route_maintenance.html">
         22. Routing and route maintenance
        </a>
       </li>
       <li>
        <a href="unet-handbook_transport_service.html">
         23. Transport service
        </a>
       </li>
       <li>
        <a href="unet-handbook_remote_access.html">
         24. Remote access
        </a>
       </li>
       <li>
        <a href="unet-handbook_state_persistence.html">
         25. State persistence
        </a>
       </li>
       <li>
        <a href="unet-handbook_scheduler.html">
         26. Scheduler
        </a>
       </li>
       <li>
        <a href="unet-handbook_shell.html">
         27. Shell
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="unet-handbook_part_v_extending_unetstack.html">
       <strong>
        Part V: Extending UnetStack
       </strong>
      </a>
      <ul class="sectlevel1">
       <li>
        <a href="unet-handbook_developing_your_own_agents.html">
         28. Developing your own agents
        </a>
       </li>
       <li>
        <a href="unet-handbook_implementing_network_protocols.html">
         29. Implementing network protocols
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="unet-handbook_part_vi_simulating_underwater_networks.html">
       <strong>
        Part VI: Simulating underwater networks
       </strong>
      </a>
      <ul class="sectlevel1">
       <li>
        <a href="unet-handbook_writing_simulation_scripts.html">
         30. Writing simulation scripts
        </a>
       </li>
       <li>
        <a href="unet-handbook_discrete_event_simulation.html">
         31. Discrete event simulation
        </a>
       </li>
       <li>
        <a href="unet-handbook_modems_and_channel_models.html">
         32. Modems and channel models
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="unet-handbook_appendices.html">
       <strong>
        Appendices
       </strong>
      </a>
      <ul class="sectlevel1">
       <li>
        <a href="unet-handbook_faqs_and_resources.html">
         Appendix A: FAQs and resources
        </a>
       </li>
       <li>
        <a href="unet-handbook_list_of_services.html">
         Appendix B: List of services
        </a>
       </li>
       <li>
        <a href="unet-handbook_command_reference.html">
         Appendix C: Command reference
        </a>
       </li>
       <li>
        <a href="unet-handbook_mysimplehandshakemac.html">
         Appendix D: MySimpleHandshakeMac
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </div>
  </div>
  <div id="content">
   <div class="sect1">
    <h2 id="_implementing_network_protocols">
     29. Implementing network protocols
    </h2>
    <div class="sectionbody">
     <div class="paragraph">
      <p>
       You now know how to write simple agents. But real world network protocols demand more complexity such as advertising services, looking up other agents, providing parameters that are computed on demand, encoding/decoding complex PDUs, generating random variates, and describing behaviors as finite state machines (FSMs). In this chapter, we illustrate how to do all these things with ease, using a few examples.
      </p>
     </div>
     <div class="paragraph">
      <p>
       In
       <a href="unet-handbook_medium_access_control.html">
        Chapter 20
       </a>
       , we looked at the MAC service in detail. In the next few sections, we develop three simple MAC agents (
       <code>
        MySimplestMac
       </code>
       ,
       <code>
        MySimpleThrottledMac
       </code>
       and
       <code>
        MySimpleHandshakeMac
       </code>
       ) to illustrate how network protocols and services are implemented by agents. The MAC agents are intentionally kept simple and not optimized for performance, as we wish to illustrate the key aspects of MAC agent development without getting lost in the details of optimal protocols.
      </p>
     </div>
     <div class="sect2">
      <h3 id="_simple_mac_without_handshake">
       29.1. Simple MAC without handshake
      </h3>
      <div class="paragraph">
       <p>
        To illustrate how a MAC agent might work, let us start with a simple MAC agent that grants every reservation request as soon as it is made:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.mac.*</span>

<span class="kd">class</span> <span class="nc">MySimplestMac</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">register</span> <span class="n">Services</span><span class="o">.</span><span class="na">MAC</span>                <span class="c1">// advertise that the agent provides a MAC service</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">Message</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">ReservationReq</span><span class="o">)</span> <span class="o">{</span>

      <span class="c1">// check requested duration</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="n">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Bad reservation duration'</span><span class="o">)</span>

      <span class="c1">// prepare START reservation notification</span>
      <span class="n">ReservationStatusNtf</span> <span class="n">ntf1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
        <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
        <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
        <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
        <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">START</span><span class="o">)</span>

      <span class="c1">// prepare END reservation notification</span>
      <span class="n">ReservationStatusNtf</span> <span class="n">ntf2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
        <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
        <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
        <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
        <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">END</span><span class="o">)</span>

      <span class="c1">// send START reservation notification immediately</span>
      <span class="n">add</span> <span class="k">new</span> <span class="nf">OneShotBehavior</span><span class="o">({</span>
        <span class="n">send</span> <span class="n">ntf1</span>
      <span class="o">})</span>

      <span class="c1">// wait for reservation duration, and then send END reservation notification</span>
      <span class="n">add</span> <span class="k">new</span> <span class="nf">WakerBehavior</span><span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">),</span> <span class="o">{</span>
        <span class="n">send</span> <span class="n">ntf2</span>
      <span class="o">})</span>

      <span class="c1">// return a reservation response, which defaults to an AGREE performative</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ReservationRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Note a number of interesting features of the code above:
       </p>
      </div>
      <div class="olist arabic">
       <ol class="arabic">
        <li>
         <p>
          The
          <code>
           setup()
          </code>
          method is used to advertise the service provided by this agent.
         </p>
        </li>
        <li>
         <p>
          We provide basic error checking, and refuse a request that is invalid, providing a descriptive reason.
         </p>
        </li>
        <li>
         <p>
          We prepare the AGREE response as well as the START and END status notification messages, all at once. We send out the START notification immediately (using a
          <code>
           OneShotBehavior
          </code>
          ), use a
          <code>
           WakerBehavior
          </code>
          to schedule the END notification to be sent out at an appropriate time, and then simply return the AGREE response. The use of the
          <code>
           OneShotBehavior
          </code>
          ensures that the START notification is sent after the AGREE response, and not before.
         </p>
        </li>
        <li>
         <p>
          We return a
          <code>
           null
          </code>
          if we donâ€™t understand the request, allowing the superclass to respond with a NOT_UNDERSTOOD message.
         </p>
        </li>
       </ol>
      </div>
      <div class="paragraph">
       <p>
        While the above code implements a fully functional MAC agent, it needs to respond to
        <code>
         ReservationCancelReq
        </code>
        ,
        <code>
         ReservationAcceptReq
        </code>
        and
        <code>
         TxAckReq
        </code>
        messages, and provide
        <code>
         channelBusy
        </code>
        ,
        <code>
         reservationPayloadSize
        </code>
        ,
        <code>
         ackPayloadSize
        </code>
        ,
        <code>
         maxReservationDuration
        </code>
        and
        <code>
         recommendedReservationDuration
        </code>
        parameters in order to comply with the MAC service specification (
        <a href="unet-handbook_medium_access_control.html">
         Chapter 20
        </a>
        ). We add this functionality trivially, by responding to the messages with
        <code>
         RefuseRsp
        </code>
        (message with a
        <code>
         REFUSE
        </code>
        performative and a descriptive reason), and returning default values for all the parameters. The resulting complete source code is shown below:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span>
<span class="kn">import</span> <span class="nn">org.arl.fjage.param.Parameter</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.mac.*</span>

<span class="kd">class</span> <span class="nc">MySimplestMac</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">register</span> <span class="n">Services</span><span class="o">.</span><span class="na">MAC</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">Message</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nl">ReservationReq:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="n">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Bad reservation duration'</span><span class="o">)</span>
        <span class="n">ReservationStatusNtf</span> <span class="n">ntf1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
          <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
          <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
          <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">START</span><span class="o">)</span>
        <span class="n">ReservationStatusNtf</span> <span class="n">ntf2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
          <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
          <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
          <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">END</span><span class="o">)</span>
        <span class="n">add</span> <span class="k">new</span> <span class="nf">OneShotBehavior</span><span class="o">({</span>
          <span class="n">send</span> <span class="n">ntf1</span>
        <span class="o">})</span>
        <span class="n">add</span> <span class="k">new</span> <span class="nf">WakerBehavior</span><span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">),</span> <span class="o">{</span>
          <span class="n">send</span> <span class="n">ntf2</span>
        <span class="o">})</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ReservationRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
      <span class="k">case</span> <span class="nl">ReservationCancelReq:</span>
      <span class="k">case</span> <span class="nl">ReservationAcceptReq:</span>                      <span class="c1">// respond to other requests defined</span>
      <span class="k">case</span> <span class="nl">TxAckReq:</span>                                  <span class="c1">//  by the MAC service with a RefuseRsp</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Not supported'</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="o">}</span>

  <span class="c1">// expose parameters defined by the MAC service, with just default values</span>

  <span class="nd">@Override</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Parameter</span><span class="o">&gt;</span> <span class="n">getParameterList</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">allOf</span><span class="o">(</span><span class="n">MacParam</span><span class="o">)</span>                            <span class="c1">// advertise the list of parameters</span>
  <span class="o">}</span>

  <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">channelBusy</span> <span class="o">=</span> <span class="kc">false</span>                   <span class="c1">// parameters are marked as 'final'</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">reservationPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>                <span class="c1">//  to ensure that they are read-only</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">ackPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">final</span> <span class="kt">float</span> <span class="n">maxReservationDuration</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="na">POSITIVE_INFINITY</span>
  <span class="kd">final</span> <span class="n">Float</span> <span class="n">recommendedReservationDuration</span> <span class="o">=</span> <span class="kc">null</span>

<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Now we have a fully-compliant, but very simple, MAC agent!
       </p>
      </div>
     </div>
     <div class="sect2">
      <h3 id="_testing_our_simple_mac">
       29.2. Testing our simple MAC
      </h3>
      <div class="paragraph">
       <p>
        The
        <code>
         MySimplestMac
        </code>
        agent from the previous section is available in the
        <code>
         samples
        </code>
        folder of your Unet simulator. To test it, fire up the 2-node network simulator and connect to node A:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="unet">&gt; ps
remote: org.arl.unet.remote.RemoteControl - IDLE
state: org.arl.unet.state.StateManager - IDLE
rdp: org.arl.unet.net.RouteDiscoveryProtocol - IDLE
ranging: org.arl.unet.phy.Ranging - IDLE
uwlink: org.arl.unet.link.ECLink - IDLE
node: org.arl.unet.nodeinfo.NodeInfo - IDLE
websh: org.arl.fjage.shell.ShellAgent - RUNNING
simulator: org.arl.unet.sim.SimulationAgent - IDLE
phy: org.arl.unet.sim.HalfDuplexModem - IDLE
bbmon: org.arl.unet.bb.BasebandSignalMonitor - IDLE
arp: org.arl.unet.addr.AddressResolution - IDLE
transport: org.arl.unet.transport.SWTransport - IDLE
router: org.arl.unet.net.Router - IDLE
mac: org.arl.unet.mac.CSMA - IDLE</code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        We see that the
        <code>
         org.arl.unet.mac.CSMA
        </code>
        agent is the current
        <code>
         mac
        </code>
        . To use our
        <code>
         MySimplestMac
        </code>
        agent, you first need to kill the
        <code>
         org.arl.unet.mac.CSMA
        </code>
        agent, and then load the
        <code>
         MySimplestMac
        </code>
        agent:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="unet">&gt; container.kill mac
true
&gt; container.add 'mac', new MySimplestMac()
mac
&gt; ps
remote: org.arl.unet.remote.RemoteControl - IDLE
state: org.arl.unet.state.StateManager - IDLE
rdp: org.arl.unet.net.RouteDiscoveryProtocol - IDLE
ranging: org.arl.unet.phy.Ranging - IDLE
uwlink: org.arl.unet.link.ECLink - IDLE
node: org.arl.unet.nodeinfo.NodeInfo - IDLE
websh: org.arl.fjage.shell.ShellAgent - RUNNING
simulator: org.arl.unet.sim.SimulationAgent - IDLE
phy: org.arl.unet.sim.HalfDuplexModem - IDLE
bbmon: org.arl.unet.bb.BasebandSignalMonitor - IDLE
arp: org.arl.unet.addr.AddressResolution - IDLE
transport: org.arl.unet.transport.SWTransport - IDLE
router: org.arl.unet.net.Router - IDLE
mac: MySimplestMac - IDLE

&gt; mac
Â« MySimplestMac Â»

[org.arl.unet.mac.MacParam]
  ackPayloadSize â¤‡ 0
  channelBusy â¤‡ false
  maxReservationDuration â¤‡ Infinity
  recommendedReservationDuration â¤‡ null
  reservationPayloadSize â¤‡ 0</code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Itâ€™s loaded and working!
       </p>
      </div>
      <div class="paragraph">
       <p>
        Now, you can ask for a reservation and see if it responds correctly:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="unet">&gt; mac &lt;&lt; new ReservationReq(to: 31, duration: 3.seconds)
ReservationRsp:AGREE
mac &gt;&gt; ReservationStatusNtf:INFORM[to:31 status:START]
mac &gt;&gt; ReservationStatusNtf:INFORM[to:31 status:END]</code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Indeed it does! The START notification arrives immediately after the AGREE response, and the END notification arrives about 3 seconds later.
       </p>
      </div>
      <div class="sidebarblock">
       <div class="content">
        <div class="title">
         Logging and debugging
        </div>
        <div class="paragraph">
         <p>
          When testing agents, youâ€™ll often feel the need to log debug information. Every agent already has a Java logger (
          <code>
           log
          </code>
          ) defined, and can be used to log information to the log file (
          <code>
           logs/log-0.txt
          </code>
          ). The Java logger supports various levels of logging:
          <code>
           severe
          </code>
          ,
          <code>
           warning
          </code>
          ,
          <code>
           info
          </code>
          ,
          <code>
           fine
          </code>
          ,
          <code>
           finer
          </code>
          ,
          <code>
           finest
          </code>
          . For example, to log a message at a fine level, simply do something like:
         </p>
        </div>
        <div class="listingblock">
         <div class="content">
          <pre class="rouge highlight"><code data-lang="groovy"><span class="n">log</span><span class="o">.</span><span class="na">fine</span> <span class="s1">'Some debugging information'</span></code></pre>
         </div>
        </div>
        <div class="paragraph">
         <p>
          The log level can be controlled on a per-class or per-package basis using the
          <code>
           logLevel
          </code>
          command on the Unet shell (type
          <code>
           help logLevel
          </code>
          for details). To set the current log level to include fine level logs:
         </p>
        </div>
        <div class="listingblock">
         <div class="content">
          <pre class="rouge highlight"><code data-lang="unet">&gt; logLevel FINE</code></pre>
         </div>
        </div>
        <div class="paragraph">
         <p>
          You can access the logs from the web interface "Logs" tab, or on your disk in the
          <code>
           logs
          </code>
          folder. The active agent log file is always called
          <code>
           log-0.txt
          </code>
          . To see the last few lines of this file from your shell:
         </p>
        </div>
        <div class="listingblock">
         <div class="content">
          <pre class="rouge highlight"><code data-lang="unet">&gt; tail
1568482567444|INFO|org.arl.unet.remote.RemoteControl/B@57:startup|Using transport for communication
1568482567447|INFO|org.arl.unet.link.ECLink/B@59:startup|No PHY specified, auto detecting...
1568482567448|INFO|org.arl.unet.link.ECLink/B@59:startup|Using agent 'phy' for PHY
1568482567448|INFO|org.arl.unet.link.ECLink/B@59:startup|No MAC specified, auto detecting...
1568482567449|INFO|org.arl.unet.link.ECLink/B@59:startup|Using agent 'mac' for MAC
1568482567451|INFO|org.arl.unet.transport.SWTransport/B@69:startup|Using router for communication
1568482567453|INFO|org.arl.unet.remote.RemoteControl/B@57:startup|Using websh for command exec
1568482567511|INFO|org.arl.unet.remote.RemoteControl/A@42:startup|Using websh for command exec
1568482572443|INFO|org.arl.unet.nodeinfo.NodeInfo/A@52:obtainAddress|Node name is A, address is 232, address size is 8 bits
1568482572449|INFO|org.arl.unet.nodeinfo.NodeInfo/B@68:obtainAddress|Node name is B, address is 31, address size is 8 bits
1568482584194|INFO|MySimplestMac/A@72:init|Loading agent mac [MySimplestMac] on A</code></pre>
         </div>
        </div>
       </div>
      </div>
     </div>
     <div class="sect2">
      <h3 id="_simple_mac_with_throttling">
       29.3. Simple MAC with throttling
      </h3>
      <div class="paragraph">
       <p>
        While the above simple MAC would work well when the traffic offered to it is random, it will perform poorly if the network is fully loaded. All nodes would constantly try to access the channel, collide and the throughput would plummet. To address this concern, one may add an exponentially distributed random backoff (Poisson arrival to match the assumption of Aloha) for every request, to introduce randomness. The backoff could be chosen to offer a normalized network load of approximately 0.5, since this generates the highest throughput for Aloha.
       </p>
      </div>
      <div class="paragraph">
       <p>
        Hereâ€™s the updated code with some bells and whistles:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span>
<span class="kn">import</span> <span class="nn">org.arl.fjage.param.Parameter</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.phy.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.mac.*</span>

<span class="kd">class</span> <span class="nc">MySimpleThrottledMac</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">double</span> <span class="n">TARGET_LOAD</span>     <span class="o">=</span> <span class="mf">0.5</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span>    <span class="n">MAX_QUEUE_LEN</span>   <span class="o">=</span> <span class="mi">16</span>

  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="kd">private</span> <span class="n">AgentID</span> <span class="n">phy</span>
  <span class="kt">boolean</span> <span class="n">busy</span> <span class="o">=</span> <span class="kc">false</span>   <span class="c1">// is a reservation currently ongoing?</span>
  <span class="n">Long</span> <span class="n">t0</span> <span class="o">=</span> <span class="kc">null</span>         <span class="c1">// time of last reservation start, or null</span>
  <span class="n">Long</span> <span class="n">t1</span> <span class="o">=</span> <span class="kc">null</span>         <span class="c1">// time of last reservation end, or null</span>
  <span class="kt">int</span> <span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">register</span> <span class="n">Services</span><span class="o">.</span><span class="na">MAC</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">startup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">phy</span> <span class="o">=</span> <span class="n">agentForService</span><span class="o">(</span><span class="n">Services</span><span class="o">.</span><span class="na">PHYSICAL</span><span class="o">)</span>     <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">Message</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nl">ReservationReq:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="n">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Bad reservation duration'</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">waiting</span> <span class="o">&gt;=</span> <span class="n">MAX_QUEUE_LEN</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="n">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Queue full'</span><span class="o">)</span>
        <span class="n">ReservationStatusNtf</span> <span class="n">ntf1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
          <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
          <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
          <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">START</span><span class="o">)</span>
        <span class="n">ReservationStatusNtf</span> <span class="n">ntf2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
          <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
          <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
          <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">END</span><span class="o">)</span>

        <span class="c1">// grant the request after a random backoff                         </span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">AgentLocalRandom</span> <span class="n">rnd</span> <span class="o">=</span> <span class="n">AgentLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">()</span>                   <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="kt">double</span> <span class="n">backoff</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="na">nextExp</span><span class="o">(</span><span class="n">TARGET_LOAD</span><span class="s">/msg.duration/</span><span class="n">nodes</span><span class="o">)</span>        <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="n">currentTimeMillis</span><span class="o">()</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t0</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">)</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t0</span> <span class="o">+=</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">backoff</span><span class="o">)</span>  <span class="c1">// schedule packet with a random backoff</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t0</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">)</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">t1</span>            <span class="c1">//   after the last scheduled packet </span><i class="conum" data-value="6"></i><b>(6)</b>
        <span class="kt">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">duration</span>
        <span class="n">waiting</span><span class="o">++</span>
        <span class="n">add</span> <span class="k">new</span> <span class="nf">WakerBehavior</span><span class="o">(</span><span class="n">t0</span><span class="o">-</span><span class="n">t</span><span class="o">,</span> <span class="o">{</span>            <i class="conum" data-value="7"></i><b>(7)</b>
          <span class="n">send</span> <span class="n">ntf1</span>
          <span class="n">busy</span> <span class="o">=</span> <span class="kc">true</span>
          <span class="n">waiting</span><span class="o">--</span>
          <span class="n">add</span> <span class="k">new</span> <span class="nf">WakerBehavior</span><span class="o">(</span><span class="n">duration</span><span class="o">,</span> <span class="o">{</span>
            <span class="n">send</span> <span class="n">ntf2</span>
            <span class="n">busy</span> <span class="o">=</span> <span class="kc">false</span>
          <span class="o">})</span>
        <span class="o">})</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">ReservationRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
      <span class="k">case</span> <span class="nl">ReservationCancelReq:</span>
      <span class="k">case</span> <span class="nl">ReservationAcceptReq:</span>
      <span class="k">case</span> <span class="nl">TxAckReq:</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Not supported'</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="o">}</span>

  <span class="c1">// expose parameters defined by the MAC service, and one additional parameter</span>

  <span class="nd">@Override</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Parameter</span><span class="o">&gt;</span> <span class="n">getParameterList</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">allOf</span><span class="o">(</span><span class="n">MacParam</span><span class="o">,</span> <span class="n">Param</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="kd">enum</span> <span class="n">Param</span> <span class="kd">implements</span> <span class="n">Parameter</span> <span class="o">{</span>
    <span class="n">nodes</span>                                        <i class="conum" data-value="8"></i><b>(8)</b>
  <span class="o">}</span>

  <span class="kt">int</span> <span class="n">nodes</span> <span class="o">=</span> <span class="mi">6</span>                          <span class="c1">// number of nodes in network, to be set by user</span>

  <span class="kd">final</span> <span class="kt">int</span> <span class="n">reservationPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">ackPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">final</span> <span class="kt">float</span> <span class="n">maxReservationDuration</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="na">POSITIVE_INFINITY</span>

  <span class="kt">boolean</span> <span class="nf">getChannelBusy</span><span class="o">()</span> <span class="o">{</span>                     <i class="conum" data-value="9"></i><b>(9)</b>
    <span class="k">return</span> <span class="n">busy</span>
  <span class="o">}</span>

  <span class="kt">float</span> <span class="nf">getRecommendedReservationDuration</span><span class="o">()</span> <span class="o">{</span>    <i class="conum" data-value="10"></i><b>(10)</b>
    <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">phy</span><span class="o">,</span> <span class="n">Physical</span><span class="o">.</span><span class="na">DATA</span><span class="o">,</span> <span class="n">PhysicalChannelParam</span><span class="o">.</span><span class="na">frameDuration</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tr>
         <td>
          <i class="conum" data-value="1">
          </i>
          <b>
           1
          </b>
         </td>
         <td>
          We define a few attributes to keep track of channel state and reservation queue.
         </td>
        </tr>
        <tr>
         <td>
          <i class="conum" data-value="2">
          </i>
          <b>
           2
          </b>
         </td>
         <td>
          We lookup other agents in
          <code>
           startup()
          </code>
          after they have had a chance to advertise their services during the setup phase.
         </td>
        </tr>
        <tr>
         <td>
          <i class="conum" data-value="3">
          </i>
          <b>
           3
          </b>
         </td>
         <td>
          Requests are no longer granted immediately, but after a random backoff instead.
         </td>
        </tr>
        <tr>
         <td>
          <i class="conum" data-value="4">
          </i>
          <b>
           4
          </b>
         </td>
         <td>
          Random numbers are generated using a
          <code>
           AgentLocalRandom
          </code>
          utility. This utility ensures repeatable results during discrete event simulation, aiding with debugging, and so is the preferred way of generating random variates.
         </td>
        </tr>
        <tr>
         <td>
          <i class="conum" data-value="5">
          </i>
          <b>
           5
          </b>
         </td>
         <td>
          The
          <code>
           nextExp()
          </code>
          function generate a exponentially distributed random number with a specified rate parameter. The rate parameter is computed such that the average backoff introduced helps to achieve the specified target load.
         </td>
        </tr>
        <tr>
         <td>
          <i class="conum" data-value="6">
          </i>
          <b>
           6
          </b>
         </td>
         <td>
          In Groovy, a comparison with
          <code>
           null
          </code>
          (initial value of
          <code>
           t1
          </code>
          ) is permitted, and will always be false.
         </td>
        </tr>
        <tr>
         <td>
          <i class="conum" data-value="7">
          </i>
          <b>
           7
          </b>
         </td>
         <td>
          Note that we no longer send the START notification immediately. Instead we schedule it after a backoff, and then schedule the END notification after the reservation duration from the START.
         </td>
        </tr>
        <tr>
         <td>
          <i class="conum" data-value="8">
          </i>
          <b>
           8
          </b>
         </td>
         <td>
          We implement one user configurable parameter
          <code>
           nodes
          </code>
          , and advertise it.
         </td>
        </tr>
        <tr>
         <td>
          <i class="conum" data-value="9">
          </i>
          <b>
           9
          </b>
         </td>
         <td>
          Parameter
          <code>
           busy
          </code>
          is no longer always false, since we now keep track of reservations. We return
          <code>
           busy
          </code>
          to be true only during the time between a reservation START and END.
         </td>
        </tr>
        <tr>
         <td>
          <i class="conum" data-value="10">
          </i>
          <b>
           10
          </b>
         </td>
         <td>
          Parameter
          <code>
           recommendedReservationDuration
          </code>
          is now determined based on the frame duration of the PHYSICAL service, assuming that most reservations are for transmitting one frame. A client is free to choose a longer reservation time, if it wishes to transmit many frames in one go (as it should for efficient use of the channel).
         </td>
        </tr>
       </table>
      </div>
      <div class="paragraph">
       <p>
        A copy of this code is available in the
        <code>
         samples
        </code>
        folder of your Unet simulator. We encourage you to test it out, in the same way as we tested
        <code>
         MySimplestMac
        </code>
        in
        <a href="unet-handbook_implementing_network_protocols.html#_testing_our_simple_mac">
         Section 29.2
        </a>
        . Youâ€™ll find that the START notification no longer arrives immediately after the AGREE response, but arrives a few seconds later, after a random backoff.
       </p>
      </div>
     </div>
     <div class="sect2">
      <h3 id="_simple_mac_with_handshake">
       29.4. Simple MAC with handshake
      </h3>
      <div class="paragraph">
       <p>
        While the MAC agents we have developed so far are fully functional, they are simple, and do not involve any signaling for channel reservation. Many MAC protocols such as MACA and FAMA involve a handshake using RTS and CTS PDUs. To illustrate how more complex protocols are developed using UnetStack, we implement a simple RTS-CTS 2-way handshake-based MAC agent next.
       </p>
      </div>
      <div class="paragraph">
       <p>
        Many communication protocols are best described using an FSM. We illustrate the FSM for our simple handshake-based MAC agent in
        <a href="#fig_fsm">
         Figure 10
        </a>
        .
       </p>
      </div>
      <div class="imageblock" id="fig_fsm">
       <div class="content">
        <img alt="fsm" src="images/fsm.png"/>
       </div>
       <div class="title">
        Figure 10. Finite state machine (FSM) for the simple handshake-based MAC protocol.
       </div>
      </div>
      <div class="paragraph">
       <p>
        When the channel is free, the agent is in an IDLE state. If the agent receives a
        <code>
         ReservationReq
        </code>
        , it switches to the RTS state and sends an RTS PDU to the intended destination node. If it receives a CTS PDU back, then it switches to a TX state and urges the client to transmit data via a
        <code>
         ReservationStatusNtf
        </code>
        with a START status. After the reservation period is over, the agent switches back to the IDLE state. If no CTS PDU is received in the RTS state for a while, the agent times out and returns to the IDLE state after informing the client of a reservation FAILURE.
       </p>
      </div>
      <div class="paragraph">
       <p>
        If the agent receives an RTS PDU in the IDLE state, it switches to the RX state and responds with a CTS PDU. The node initiating the handshake may then transmit data for the reservation duration. After the duration (plus some allowance for 2-way propagation delay), the agent switches back to the IDLE state. If the agent overhears (aka snoops) RTS or CTS PDUs destined for other nodes, it switches to a BACKOFF state for a while. During the state, it does not initiate or respond to RTS PDUs. After the backoff period, it switches back to the IDLE state.
       </p>
      </div>
      <div class="paragraph">
       <p>
        Our RTS and CTS PDUs are identified by a protocol number. Since we are implementing a MAC protocol, we choose to tag our PDUs using the protocol number reserved for MAC agents (
        <code>
         Protocol.MAC
        </code>
        ). We also define some timeouts and delays that we will need to use:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="kt">int</span> <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">MAC</span>

<span class="kt">float</span> <span class="n">RTS_BACKOFF</span>     <span class="o">=</span> <span class="mi">2</span><span class="o">.</span><span class="na">seconds</span>
<span class="kt">float</span> <span class="n">CTS_TIMEOUT</span>     <span class="o">=</span> <span class="mi">5</span><span class="o">.</span><span class="na">seconds</span>
<span class="kt">float</span> <span class="n">BACKOFF_RANDOM</span>  <span class="o">=</span> <span class="mi">5</span><span class="o">.</span><span class="na">seconds</span>
<span class="kt">float</span> <span class="n">MAX_PROP_DELAY</span>  <span class="o">=</span> <span class="mi">2</span><span class="o">.</span><span class="na">seconds</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Communication protocols often use complicated PDU formats. UnetStack provides a
        <code>
         PDU
        </code>
        class to help encode/decode PDUs. Although the RTS and CTS PDUs have a pretty simple format, the PDU is still useful in defining the format clearly:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="kt">int</span> <span class="n">RTS_PDU</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="kt">int</span> <span class="n">CTS_PDU</span> <span class="o">=</span> <span class="mh">0x02</span>

<span class="n">PDU</span> <span class="n">pdu</span> <span class="o">=</span> <span class="n">PDU</span><span class="o">.</span><span class="na">withFormat</span> <span class="o">{</span>
  <span class="n">uint8</span><span class="o">(</span><span class="s1">'type'</span><span class="o">)</span>         <span class="c1">// RTS_PDU/CTS_PDU</span>
  <span class="n">uint16</span><span class="o">(</span><span class="s1">'duration'</span><span class="o">)</span>    <span class="c1">// ms</span>
<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Here we have defined a PDU with two fieldsâ€‰â€”â€‰type (8 bit) and duration (16 bit). The type may be either of RTS_PDU or CTS_PDU, while the duration will specify the reservation duration in milliseconds. We will later use this
        <code>
         pdu
        </code>
        object to encode and decode these PDUs.
       </p>
      </div>
      <div class="sidebarblock">
       <div class="content">
        <div class="title">
         Encoding and decoding PDUs
        </div>
        <div class="paragraph">
         <p>
          Since encoding and decoding of PDUs is required in almost all protocol implementations, UnetStack provides a
          <a href="https://unetstack.net/javadoc/3.1/index.html?org/arl/unet/PDU.html" rel="noopener" target="_blank">
           <code>
            PDU
           </code>
          </a>
          class to help you with it. The
          <code>
           PDU
          </code>
          class provides a declarative syntax for describing the PDU format. Once you have the PDU format declared, encoding and decoding PDUs is simply a matter of calling the
          <code>
           encode()
          </code>
          and
          <code>
           decode()
          </code>
          methods.
         </p>
        </div>
        <div class="paragraph">
         <p>
          This is best illustrated with an example that you can try on a shell:
         </p>
        </div>
        <div class="listingblock">
         <div class="content">
          <pre class="rouge highlight"><code data-lang="unet">&gt; import java.nio.ByteOrder
&gt; pdu = PDU.withFormat {
-    length(16)                     // 16 byte PDU
-    order(ByteOrder.BIG_ENDIAN)    // byte ordering is big endian
-    uint8('type')                  // 1 byte field 'type'
-    uint8(0x01)                    // literal byte 0x01
-    filler(2)                      // 2 filler bytes
-    uint16('data')                 // 2 byte field 'data' as unsigned short
-    padding(0xff)                  // padded with 0xff to make 16 bytes
- };
&gt; bytes = pdu.encode([type: 7, data: 42])
[7, 1, 0, 0, 0, 42, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1]
&gt; pdu.decode(bytes)
[data:42, type:7]</code></pre>
         </div>
        </div>
        <div class="paragraph">
         <p>
          The PDU length is defined using the
          <code>
           length
          </code>
          declaration, and the byte order is defined with the
          <code>
           order
          </code>
          declaration. Supported fields include
          <code>
           uint8
          </code>
          ,
          <code>
           int8
          </code>
          ,
          <code>
           uint16
          </code>
          ,
          <code>
           int16
          </code>
          ,
          <code>
           uint32
          </code>
          ,
          <code>
           int32
          </code>
          ,
          <code>
           int64
          </code>
          , and
          <code>
           chars
          </code>
          (string). Fillers and paddings are defined with
          <code>
           filler
          </code>
          and
          <code>
           padding
          </code>
          declarations.
         </p>
        </div>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Now comes the heart of our MAC protocol implementation â€“- the FSM shown in
        <a href="#fig_fsm">
         Figure 10
        </a>
        . First we define the FSM states and the events that the FSM reacts to:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="kd">enum</span> <span class="n">State</span> <span class="o">{</span>
  <span class="n">IDLE</span><span class="o">,</span> <span class="n">RTS</span><span class="o">,</span> <span class="n">TX</span><span class="o">,</span> <span class="n">RX</span><span class="o">,</span> <span class="n">BACKOFF</span>
<span class="o">}</span>

<span class="kd">enum</span> <span class="n">Event</span> <span class="o">{</span>
  <span class="n">RX_RTS</span><span class="o">,</span> <span class="n">RX_CTS</span><span class="o">,</span> <span class="n">SNOOP_RTS</span><span class="o">,</span> <span class="n">SNOOP_CTS</span>
<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Next we use the
        <code>
         FSMBuilder
        </code>
        utility class to construct a
        <code>
         FSMBehavior
        </code>
        from a declarative concise representation of the FSM.
       </p>
      </div>
      <div class="paragraph">
       <p>
        The FSM states are defined using the
        <code>
         state(â€¦â€‹)
        </code>
        declarations. The actions to take when entering/exiting a state are defined in the
        <code>
         onEnter
        </code>
        /
        <code>
         onExit
        </code>
        clauses. The behavior of the FSM in response to events are defined using the
        <code>
         onEvent(â€¦â€‹)
        </code>
        clauses. Timers that operate in a state are defined using the
        <code>
         after(â€¦â€‹)
        </code>
        clauses. Finally actions to take continuously while in a state are defined using the
        <code>
         action
        </code>
        clause.
       </p>
      </div>
      <div class="sidebarblock">
       <div class="content">
        <div class="title">
         Finite state machines (FSMs)
        </div>
        <div class="paragraph">
         <p>
          FSMs are very commonly used in network protocol development. Although fjÃ¥ge provides a
          <a href="https://org-arl.github.io/fjage/javadoc/index.html?org/arl/fjage/FSMBehavior.html" rel="noopener" target="_blank">
           <code>
            FSMBehavior
           </code>
          </a>
          that helps implement FSMs in agents, it can be tedious to set up. UnetStack provides a
          <a href="https://unetstack.net/javadoc/3.1/index.html?org/arl/unet/FSMBuilder.html" rel="noopener" target="_blank">
           <code>
            FSMBuilder
           </code>
          </a>
          to make setting up FSM behaviors in agents easy.
         </p>
        </div>
        <div class="paragraph">
         <p>
          Here are the key steps in setting up the FSM:
         </p>
        </div>
        <div class="olist arabic">
         <ol class="arabic">
          <li>
           <p>
            Define the states and events in the FSM as
            <code>
             enum
            </code>
            declarations.
           </p>
          </li>
          <li>
           <p>
            Build the
            <code>
             FSMBehavior
            </code>
            using
            <code>
             FSMBuilder.build
            </code>
            . In building the FSM, you should have a
            <code>
             state(â€¦â€‹)
            </code>
            defined for each of your FSM states.
           </p>
          </li>
          <li>
           <p>
            In each FSM state, define your actions, events and timers using the
            <code>
             action
            </code>
            ,
            <code>
             onEnter
            </code>
            ,
            <code>
             onExit
            </code>
            ,
            <code>
             onEvent
            </code>
            and
            <code>
             after
            </code>
            clauses. Actions are continuously executed, like a
            <code>
             CyclicBehavior
            </code>
            , when the FSM is in the relevant state. You should call
            <code>
             block()
            </code>
            and
            <code>
             restart()
            </code>
            on the behavior to avoid busy loops when the FSM is idle. The
            <code>
             onEnter
            </code>
            and
            <code>
             onExit
            </code>
            clauses are triggered when the state is entered and exited respectively. Events are triggered when the
            <code>
             trigger()
            </code>
            method of the behavior is called and the FSM is in the specified state. Timers (
            <code>
             after
            </code>
            ) are automatically triggered after the specified amount of time after the state is entered.
           </p>
          </li>
          <li>
           <p>
            The
            <code>
             setNextState()
            </code>
            and
            <code>
             reenterState()
            </code>
            methods allow you to effect state transitions in your FSM.
           </p>
          </li>
          <li>
           <p>
            For short-lived FSMs, the
            <code>
             terminate()
            </code>
            method should be called when the FSM behavior is completed and should be terminated.
           </p>
          </li>
         </ol>
        </div>
       </div>
      </div>
      <div class="paragraph">
       <p>
        It should be easy to see the direct mapping between the FSM diagram and the FSM code below:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="kt">int</span> <span class="n">MAX_RETRY</span> <span class="o">=</span> <span class="mi">3</span>
<span class="kt">int</span> <span class="n">MAX_QUEUE_LEN</span> <span class="o">=</span> <span class="mi">16</span>

<span class="n">Queue</span><span class="o">&lt;</span><span class="n">ReservationReq</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;</span><span class="n">ReservationReq</span><span class="o">&gt;(</span><span class="n">MAX_QUEUE_LEN</span><span class="o">)</span>

<span class="n">FSMBehavior</span> <span class="n">fsm</span> <span class="o">=</span> <span class="n">FSMBuilder</span><span class="o">.</span><span class="na">build</span> <span class="o">{</span>

  <span class="kt">int</span> <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kt">float</span> <span class="n">backoff</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kt">def</span> <span class="n">rxInfo</span>

  <span class="nf">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">action</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// add random backoff for each reservation to allow other nodes</span>
        <span class="c1">// a chance to reserve, especially in case of a heavily loaded network</span>
        <span class="n">after</span><span class="o">(</span><span class="n">rnd</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">BACKOFF_RANDOM</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RTS</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">block</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">RX_RTS</span><span class="o">)</span> <span class="o">{</span> <span class="n">info</span> <span class="o">-&gt;</span>
      <span class="n">rxInfo</span> <span class="o">=</span> <span class="n">info</span>
      <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RX</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_RTS</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">backoff</span> <span class="o">=</span> <span class="n">RTS_BACKOFF</span>
      <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">BACKOFF</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_CTS</span><span class="o">)</span> <span class="o">{</span> <span class="n">info</span> <span class="o">-&gt;</span>
      <span class="n">backoff</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">duration</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">MAX_PROP_DELAY</span>
      <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">BACKOFF</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RTS</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">onEnter</span> <span class="o">{</span>
      <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">peek</span><span class="o">()</span>
      <span class="kt">def</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pdu</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span>
        <span class="nl">type:</span> <span class="n">RTS_PDU</span><span class="o">,</span>
        <span class="nl">duration:</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">*</span><span class="mi">1000</span><span class="o">))</span>
      <span class="n">phy</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">TxFrameReq</span><span class="o">(</span>
        <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
        <span class="nl">type:</span> <span class="n">Physical</span><span class="o">.</span><span class="na">CONTROL</span><span class="o">,</span>
        <span class="nl">protocol:</span> <span class="n">PROTOCOL</span><span class="o">,</span>
        <span class="nl">data:</span> <span class="n">bytes</span><span class="o">)</span>
      <span class="n">after</span><span class="o">(</span><span class="n">CTS_TIMEOUT</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(++</span><span class="n">retryCount</span> <span class="o">&gt;=</span> <span class="n">MAX_RETRY</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sendReservationStatusNtf</span><span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">(),</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">FAILURE</span><span class="o">)</span>
          <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="o">}</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">RX_CTS</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">TX</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">TX</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">onEnter</span> <span class="o">{</span>
      <span class="n">ReservationReq</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">()</span>
      <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">sendReservationStatusNtf</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">START</span><span class="o">)</span>
      <span class="n">after</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sendReservationStatusNtf</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">END</span><span class="o">)</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RX</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">onEnter</span> <span class="o">{</span>
      <span class="kt">def</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pdu</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span>
        <span class="nl">type:</span> <span class="n">CTS_PDU</span><span class="o">,</span>
        <span class="nl">duration:</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">rxInfo</span><span class="o">.</span><span class="na">duration</span><span class="o">*</span><span class="mi">1000</span><span class="o">))</span>
      <span class="n">phy</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">TxFrameReq</span><span class="o">(</span>
        <span class="nl">to:</span> <span class="n">rxInfo</span><span class="o">.</span><span class="na">from</span><span class="o">,</span>
        <span class="nl">type:</span> <span class="n">Physical</span><span class="o">.</span><span class="na">CONTROL</span><span class="o">,</span>
        <span class="nl">protocol:</span> <span class="n">PROTOCOL</span><span class="o">,</span>
        <span class="nl">data:</span> <span class="n">bytes</span><span class="o">)</span>
      <span class="n">after</span><span class="o">(</span><span class="n">rxInfo</span><span class="o">.</span><span class="na">duration</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">MAX_PROP_DELAY</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="n">rxInfo</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">BACKOFF</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">onEnter</span> <span class="o">{</span>
      <span class="n">after</span><span class="o">(</span><span class="n">backoff</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_RTS</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">backoff</span> <span class="o">=</span> <span class="n">RTS_BACKOFF</span>
      <span class="n">reenterState</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_CTS</span><span class="o">)</span> <span class="o">{</span> <span class="n">info</span> <span class="o">-&gt;</span>
      <span class="n">backoff</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">duration</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">MAX_PROP_DELAY</span>
      <span class="n">reenterState</span><span class="o">()</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Do note that the above FSM includes a couple of details that were missing from the FSM diagram. Firstly, we implement a random backoff before switching to the RTS state to minimize contention. Secondly, we implement a
        <code>
         retryCount
        </code>
        counter to check the number of times a single
        <code>
         ReservationReq
        </code>
        has been tried. If it exceeds
        <code>
         MAX_RETRY
        </code>
        , we discard it. Thirdly, we have a
        <code>
         backoff
        </code>
        variable that allows different backoff times for different occasions. The variable is set each time, just before the state is changed to
        <code>
         State.BACKOFF
        </code>
        or before the backoff state is re-entered.
       </p>
      </div>
      <div class="paragraph">
       <p>
        The FSM uses a simple utility method to send out
        <code>
         ReservationStatusNtf
        </code>
        notifications:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="kt">void</span> <span class="nf">sendReservationStatusNtf</span><span class="o">(</span><span class="n">ReservationReq</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ReservationStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">send</span> <span class="k">new</span> <span class="nf">ReservationStatusNtf</span><span class="o">(</span>
    <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
    <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
    <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
    <span class="nl">from:</span> <span class="n">addr</span><span class="o">,</span>
    <span class="nl">status:</span> <span class="n">status</span><span class="o">)</span>
<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Now the hard work is done. We initialize our agent by registering the MAC service, looking up and subscribing to the PHYSICAL service (to transmit and receive PDUs), looking up our own address using the NODE_INFO service, and starting the
        <code>
         fsm
        </code>
        behavior:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="n">AgentID</span> <span class="n">phy</span>
<span class="kt">int</span> <span class="n">addr</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">register</span> <span class="n">Services</span><span class="o">.</span><span class="na">MAC</span>
<span class="o">}</span>

<span class="kt">void</span> <span class="nf">startup</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">phy</span> <span class="o">=</span> <span class="n">agentForService</span><span class="o">(</span><span class="n">Services</span><span class="o">.</span><span class="na">PHYSICAL</span><span class="o">)</span>
  <span class="n">subscribe</span><span class="o">(</span><span class="n">phy</span><span class="o">)</span>
  <span class="n">subscribe</span><span class="o">(</span><span class="n">topic</span><span class="o">(</span><span class="n">phy</span><span class="o">,</span> <span class="n">Physical</span><span class="o">.</span><span class="na">SNOOP</span><span class="o">))</span>
  <span class="n">add</span> <span class="k">new</span> <span class="nf">OneShotBehavior</span><span class="o">({</span>
    <span class="kt">def</span> <span class="n">nodeInfo</span> <span class="o">=</span> <span class="n">agentForService</span><span class="o">(</span><span class="n">Services</span><span class="o">.</span><span class="na">NODE_INFO</span><span class="o">)</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">nodeInfo</span><span class="o">,</span> <span class="n">NodeInfoParam</span><span class="o">.</span><span class="na">address</span><span class="o">)</span>
  <span class="o">})</span>
  <span class="n">add</span><span class="o">(</span><span class="n">fsm</span><span class="o">)</span>
<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Note that we subscribe to the
        <code>
         topic(phy, Physical.SNOOP)
        </code>
        in addition to
        <code>
         phy
        </code>
        . This allows us to snoop RTS/CTS PDUs destined for other nodes. Also note that the address lookup is performed in a
        <code>
         OneShotBehavior
        </code>
        to avoid having the agent to block while the node information agent is starting up.
       </p>
      </div>
      <div class="paragraph">
       <p>
        Just like in the earlier MAC implementation, we have to respond to various requests defined by the MAC service specifications:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="n">Message</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nl">ReservationReq:</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">Address</span><span class="o">.</span><span class="na">BROADCAST</span> <span class="o">||</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">addr</span><span class="o">)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Reservation must have a destination node'</span><span class="o">)</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&gt;</span> <span class="n">maxReservationDuration</span><span class="o">)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Bad reservation duration'</span><span class="o">)</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">MAX_QUEUE_LEN</span><span class="o">)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Queue full'</span><span class="o">)</span>
      <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
      <span class="n">fsm</span><span class="o">.</span><span class="na">restart</span><span class="o">()</span>    <span class="c1">// tell fsm to check queue, as it may block if empty</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ReservationRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
    <span class="k">case</span> <span class="nl">ReservationCancelReq:</span>
    <span class="k">case</span> <span class="nl">ReservationAcceptReq:</span>
    <span class="k">case</span> <span class="nl">TxAckReq:</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Not supported'</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">null</span>
<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        If we get a
        <code>
         ReservationReq
        </code>
        , we validate the attributes, add the request to our queue and return a
        <code>
         ReservationRsp
        </code>
        . For other requests that we do not support, we simply refuse them.
       </p>
      </div>
      <div class="paragraph">
       <p>
        If we receive PDUs from the physical agent, they come as
        <code>
         RxFrameNtf
        </code>
        messages via the
        <code>
         processMessage()
        </code>
        method. For all PDUs with a protocol number that we use, we decode them. We trigger appropriate FSM events in response to RTS and CTS PDUs -â€“ RX_RTS and RX_CTS events for PDUs destined to us, and SNOOP_RTS and SNOOP_CTS events for PDUs that we overhear:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="kt">void</span> <span class="nf">processMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">RxFrameNtf</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">protocol</span> <span class="o">==</span> <span class="n">PROTOCOL</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">pdu</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">data</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">info</span> <span class="o">=</span> <span class="o">[</span><span class="nl">from:</span> <span class="n">msg</span><span class="o">.</span><span class="na">from</span><span class="o">,</span> <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span> <span class="nl">duration:</span> <span class="n">rx</span><span class="o">.</span><span class="na">duration</span><span class="o">/</span><span class="mf">1000.0</span><span class="o">]</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rx</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RTS_PDU</span><span class="o">)</span>
      <span class="n">fsm</span><span class="o">.</span><span class="na">trigger</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">?</span> <span class="n">Event</span><span class="o">.</span><span class="na">RX_RTS</span> <span class="o">:</span> <span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_RTS</span><span class="o">,</span> <span class="n">info</span><span class="o">)</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">rx</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">CTS_PDU</span><span class="o">)</span>
      <span class="n">fsm</span><span class="o">.</span><span class="na">trigger</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">?</span> <span class="n">Event</span><span class="o">.</span><span class="na">RX_CTS</span> <span class="o">:</span> <span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_CTS</span><span class="o">,</span> <span class="n">info</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Finally, we expose the parameters required by the MAC service specification:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="groovy"><span class="n">List</span><span class="o">&lt;</span><span class="n">Parameter</span><span class="o">&gt;</span> <span class="n">getParameterList</span><span class="o">()</span> <span class="o">{</span>          <span class="c1">// publish list of all exposed parameters</span>
  <span class="k">return</span> <span class="nf">allOf</span><span class="o">(</span><span class="n">MacParam</span><span class="o">)</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kt">int</span> <span class="n">reservationPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c1">// read-only</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="n">ackPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>                  <span class="c1">// read-only</span>
<span class="kd">final</span> <span class="kt">float</span> <span class="n">maxReservationDuration</span> <span class="o">=</span> <span class="mf">65.535</span>   <span class="c1">// read-only</span>

<span class="kt">boolean</span> <span class="nf">getChannelBusy</span><span class="o">()</span> <span class="o">{</span>                    <span class="c1">// considered busy if fsm is not IDLE</span>
  <span class="k">return</span> <span class="n">fsm</span><span class="o">.</span><span class="na">currentState</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="n">State</span><span class="o">.</span><span class="na">IDLE</span>
<span class="o">}</span>

<span class="kt">float</span> <span class="nf">getRecommendedReservationDuration</span><span class="o">()</span> <span class="o">{</span>   <span class="c1">// recommended duration: one DATA packet</span>
  <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">phy</span><span class="o">,</span> <span class="n">Physical</span><span class="o">.</span><span class="na">DATA</span><span class="o">,</span> <span class="n">PhysicalChannelParam</span><span class="o">.</span><span class="na">frameDuration</span><span class="o">)</span>
<span class="o">}</span></code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        We are done! You can find the full listing of the
        <code>
         MySimpleHandshakeMac
        </code>
        agent in
        <a href="unet-handbook_mysimplehandshakemac.html">
         Appendix D
        </a>
        (and also in the
        <code>
         samples
        </code>
        folder of your Unet simulator).
       </p>
      </div>
     </div>
     <div class="sect2">
      <h3 id="_testing_our_simple_mac_with_handshake">
       29.5. Testing our simple MAC with handshake
      </h3>
      <div class="paragraph">
       <p>
        Letâ€™s try out this MAC. The steps are similar to
        <a href="unet-handbook_implementing_network_protocols.html#_testing_our_simple_mac">
         Section 29.2
        </a>
        , but since the handshake requires MAC to be running on all nodes, you will have to fire up the 2-node network and replace the default CSMA MAC with
        <code>
         MySimpleHandshakeMac
        </code>
        on both nodes (node A and node B):
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="unet">&gt; container.kill mac
true
&gt; container.add 'mac', new MySimpleHandshakeMac();
&gt; mac
Â« MySimpleHandshakeMac Â»

[org.arl.unet.mac.MacParam]
  ackPayloadSize â¤‡ 0
  maxReservationDuration â¤‡ 65.535
  recommendedReservationDuration â¤‡ 0.7
  reservationPayloadSize â¤‡ 0</code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        Since the handshaking involves exchange of PDUs between nodes, it is instructive to see the PDUs being exchanged by subscribing to
        <code>
         phy
        </code>
        . You can make a reservation request on node A:
       </p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="rouge highlight"><code data-lang="unet">&gt; subscribe phy
&gt; mac &lt;&lt; new ReservationReq(to: 31, duration: 3.seconds)
ReservationRsp:AGREE
phy &gt;&gt; TxFrameStartNtf:INFORM[type:CONTROL txTime:3631928985 txDuration:950]
phy &gt;&gt; RxFrameStartNtf:INFORM[type:CONTROL rxTime:3634151681]
phy &gt;&gt; RxFrameNtf:INFORM[type:CONTROL from:31 to:232 protocol:4 rxTime:3634151681 (3 bytes)]
mac &gt;&gt; ReservationStatusNtf:INFORM[to:31 from:232 status:START]
mac &gt;&gt; ReservationStatusNtf:INFORM[to:31 from:232 status:END]</code></pre>
       </div>
      </div>
      <div class="paragraph">
       <p>
        We see that a CTS is transmitted (
        <code>
         TxFrameStartNtf
        </code>
        ), then a RTS is received from node B (
        <code>
         RxFrameStartNtf
        </code>
        and
        <code>
         RxFrameNtf
        </code>
        ). The reservation starts as soon as the CTS is received, and it ends 3 seconds later. Exactly as we wanted!
       </p>
      </div>
     </div>
    </div>
   </div>
   <table width="100%">
    <tr>
     <td align="left" width="50%">
      <a href="unet-handbook_developing_your_own_agents.html" style="text-decoration: none;">
       &lt;&lt;&lt; [Developing your own agents]
      </a>
     </td>     <td align="right" width="50%">
      <a href="unet-handbook_writing_simulation_scripts.html" style="text-decoration: none;">
       [Writing simulation scripts] &gt;&gt;&gt;
      </a>
     </td>
    </tr>
   </table>
  </div>
  <div id="footer">
   <div id="footer-text">
    Version 3.1.0
    <br/>
    Last updated 2020-04-07 15:04:23 +0800
   </div>
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-52885583-1', 'auto');
    ga('send', 'pageview');
   </script>
  </div>
  <style>
   pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge {
  color: #faf6e4;
  background-color: #122b3b;
}
pre.rouge .gl {
  color: #dee5e7;
  background-color: #4e5d62;
}
pre.rouge .gp {
  color: #a8e1fe;
  font-weight: bold;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cm, pre.rouge .cpf, pre.rouge .c1, pre.rouge .cs {
  color: #6c8b9f;
  font-style: italic;
}
pre.rouge .cp {
  color: #b2fd6d;
  font-weight: bold;
}
pre.rouge .err {
  color: #fefeec;
  background-color: #cc0000;
}
pre.rouge .gr {
  color: #cc0000;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .k, pre.rouge .kd, pre.rouge .kv {
  color: #f6dd62;
  font-weight: bold;
}
pre.rouge .o, pre.rouge .ow {
  color: #4df4ff;
  font-weight: bold;
}
pre.rouge .p, pre.rouge .pi {
  color: #4df4ff;
}
pre.rouge .gd {
  color: #cc0000;
}
pre.rouge .gi {
  color: #b2fd6d;
}
pre.rouge .ge {
  font-style: italic;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gt {
  color: #dee5e7;
  background-color: #4e5d62;
}
pre.rouge .kc {
  color: #f696db;
  font-weight: bold;
}
pre.rouge .kn {
  color: #ffb000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #ffb000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #ffb000;
  font-weight: bold;
}
pre.rouge .gh {
  color: #ffb000;
  font-weight: bold;
}
pre.rouge .gu {
  color: #ffb000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #b2fd6d;
  font-weight: bold;
}
pre.rouge .no {
  color: #b2fd6d;
  font-weight: bold;
}
pre.rouge .nc {
  color: #b2fd6d;
  font-weight: bold;
}
pre.rouge .nd {
  color: #b2fd6d;
  font-weight: bold;
}
pre.rouge .nn {
  color: #b2fd6d;
  font-weight: bold;
}
pre.rouge .bp {
  color: #b2fd6d;
  font-weight: bold;
}
pre.rouge .ne {
  color: #b2fd6d;
  font-weight: bold;
}
pre.rouge .nl {
  color: #ffb000;
  font-weight: bold;
}
pre.rouge .nt {
  color: #ffb000;
  font-weight: bold;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mf, pre.rouge .mh, pre.rouge .mi, pre.rouge .il, pre.rouge .mo, pre.rouge .mx {
  color: #f696db;
  font-weight: bold;
}
pre.rouge .ld {
  color: #f696db;
  font-weight: bold;
}
pre.rouge .ss {
  color: #f696db;
  font-weight: bold;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .sb, pre.rouge .dl, pre.rouge .sd, pre.rouge .s2, pre.rouge .sh, pre.rouge .sx, pre.rouge .sr, pre.rouge .s1 {
  color: #fff0a6;
  font-weight: bold;
}
pre.rouge .se {
  color: #4df4ff;
  font-weight: bold;
}
pre.rouge .sc {
  color: #4df4ff;
  font-weight: bold;
}
pre.rouge .si {
  color: #4df4ff;
  font-weight: bold;
}
pre.rouge .nb {
  font-weight: bold;
}
pre.rouge .ni {
  color: #999999;
  font-weight: bold;
}
pre.rouge .w {
  color: #BBBBBB;
}
pre.rouge .go {
  color: #BBBBBB;
}
pre.rouge .nf, pre.rouge .fm {
  color: #a8e1fe;
}
pre.rouge .py {
  color: #a8e1fe;
}
pre.rouge .na {
  color: #a8e1fe;
}
pre.rouge .nv, pre.rouge .vc, pre.rouge .vg, pre.rouge .vi, pre.rouge .vm {
  color: #a8e1fe;
  font-weight: bold;
}
  </style>
 </body>
</html>
